<%- include('../partials/header_content') %>
<%- include('../partials/sockets') %>
<%- include('../partials/formbar_header') %>
<style>
    #apiKey {
        white-space: pre;
    }

    /* Ensure error dialog appears above all modals */
    #errorDialog {
        z-index: 10000 !important;
    }
</style>
<body style="display: flex;" role="document" tabindex="0">
    <div id="editPin" style="display: none;">
        <div class="revampDiv">
            <h1 id="pinDialogTitle"><%= pin ? 'Change PIN' : 'Set PIN' %></h1>
            <div id="editPinForm">
                <% if (pin) { %>
                <div class="editPinInputs" id="currentPinField">
                    <label for="currentPin">Current PIN:</label>
                    <input type="password" id="currentPin" name="currentPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                </div>
                <% } %>

                <div class="editPinInputs">
                    <label for="newPin">New PIN:</label>
                    <input type="password" id="newPin" name="newPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                </div>

                <div class="editPinInputs">
                    <label for="confirmNewPin">Confirm New PIN:</label>
                    <input type="password" id="confirmNewPin" name="confirmNewPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                </div>

                <div class="editPinInputs" style="margin-top: 20px;">
                    <button type="button" id="updatePinBtn" class="revampButton warningButton"><%= pin ? 'Update PIN' : 'Set PIN' %></button>
                    <button type="button" id="cancelPinBtn" class="revampButton">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id='profileInformation' class="revampDiv">
        <h1>Profile Information</h1>
        <p id='displayName'><strong>Display Name:</strong> <%- displayName %></p>

        <% if (email !== "Hidden") { %> <!-- If the user doesn't have permissions to see the email, don't show it -->
        <p id="email"><strong>Email:</strong> <%- email %></p>
        <% } %>

        <p id='digipogs'><strong>Digipogs:</strong> <%- Math.floor(digipogs) %></p>
        <p id='userId'><strong>ID:</strong> <%- id %></p>

        <% if (isOwnProfile) { %>
        <div class="sensitiveInfo">
            <p id='apiKey'><strong>API Key:</strong> ████████</p>
            <div id='apiKeyButtons'>
                <button class="squareButton hideMobile" style="display: none;" id="copyApiBtn">
                    <img src="/img/icons/clipboard-outline.svg" alt="Copy API Key">
                </button>
                <button id='apiRefresh' class="squareButton warningButton" title="Regenerate API Key">
                    <img src="/img/icons/refresh-outline.svg" alt="Regenerate API Key">
                </button>
            </div>
        </div>

        <div class="sensitiveInfo">
            <p id='pin'><strong>PIN:</strong> <%= pin ? '████' : 'Not Set' %></p>
            <div id='pinButtons'>
                <button id='pinEdit' class="squareButton warningButton" title="<%= pin ? 'Change' : 'Set' %> PIN">
                    <img src="/img/icons/pencil-outline.svg" alt="<%= pin ? 'Change' : 'Set' %> PIN">
                </button>
            </div>
        </div>
        <% } %>

        <div class="pogMeter">
            <p>Pog Meter</p>
            <div id="pogMeter" class="revampDivAlt">
                <div id="pogMeterFill"></div>
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="revampButton" id="transactionsBtn" style="margin-right: auto;">Transactions</button>
            <button class="revampButton" id="poolsBtn">Pog Pools</button>
        </div>
    </div>

</body>

<script>
    let apiKeyValue = null; // API key is hashed and cannot be displayed
    let pinValue = null; // PIN is hashed and cannot be displayed
    let pogMeterValue = <%- pogMeter / 5 %>;

    document.getElementById('pogMeterFill').style.setProperty('--pogPercent', pogMeterValue + '%');

    let apiKey = document.getElementById('apiKey');
    let pin = document.getElementById('pin');

    function copyApiKey() {
        if (apiKeyValue) {
            navigator.clipboard.writeText(apiKeyValue);
            alert("API Key copied to clipboard!");
        }
    }

    function updatePin() {
        const currentPinField = document.getElementById('currentPin');
        const currentPin = currentPinField ? currentPinField.value : null;
        const newPin = document.getElementById('newPin').value;
        const confirmNewPin = document.getElementById('confirmNewPin').value;

        // Check if current PIN field exists but is empty
        if (currentPinField && !currentPin) {
            showNotification("Current PIN is required.");
            return;
        }

        if (newPin !== confirmNewPin) {
            showNotification("New PIN and Confirm New PIN do not match.");
            return;
        }

        if (!isFinite(newPin)) {
            showNotification("PIN must only contain numbers.");
            return;
        }

        if (newPin.length < 4 || newPin.length > 6) {
            showNotification("PIN must be between 4 and 6 digits.");
            return;
        }

        // Send both currentPin and newPin to server for verification
        socket.emit('refreshPin', { currentPin, newPin });

        // Clear input fields
        if (currentPinField) currentPinField.value = '';
        document.getElementById('newPin').value = '';
        document.getElementById('confirmNewPin').value = '';

        // Close the edit PIN modal
        editPin();
    }

    function editPin() {
        document.getElementById('backgroundDarken').classList.toggle('open');
        document.getElementById('editPin').style.display =
            (document.getElementById('editPin').style.display === 'flex') ? 'none' : 'flex';
    }

    function showNotification(message, type = 'error') {
        const errorDialog = document.getElementById('errorDialog');
        const errorMessage = document.getElementById('errorMessage');
        const errorIcon = errorDialog ? errorDialog.querySelector('img') : null;

        if (errorDialog && errorMessage) {
            errorMessage.innerText = message;

            // Remove any existing type classes
            errorDialog.classList.remove('success', 'error');

            // Add the appropriate type class and icon
            if (type === 'success') {
                errorDialog.classList.add('success');
                if (errorIcon) {
                    errorIcon.src = '/img/icons/checkmark-outline.svg';
                    errorIcon.alt = 'Success Icon';
                }
            } else {
                if (errorIcon) {
                    errorIcon.src = '/img/icons/close-circle.svg';
                    errorIcon.alt = 'Error Icon';
                }
            }

            errorDialog.classList.add('shown');

            setTimeout(() => {
                errorDialog.classList.remove('shown');
            }, 3000);
        }
    }

    // Attach event listeners to all buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Handle transactions button, depending on if it's the user's own profile or not
        const userIdElement = document.getElementById('userId');
        const userIdText = userIdElement ? userIdElement.textContent.replace(/[^0-9]/g, '') : '';
        const transactionsButton = document.getElementById('transactionsBtn');
        const poolsButton = document.getElementById('poolsBtn');
        const copyBtn = document.getElementById('copyApiBtn');
        const apiRefreshBtn = document.getElementById('apiRefresh');
        const pinEditBtn = document.getElementById('pinEdit');
        const updatePinBtn = document.getElementById('updatePinBtn');
        const cancelPinBtn = document.getElementById('cancelPinBtn');

        if (transactionsButton) {
            transactionsButton.addEventListener('click', function() {
                if (<%- isOwnProfile ? 'true' : 'false' %>) {
                    location.href = '/profile/transactions';
                } else {
                    location.href = `/profile/transactions/${userIdText}`;
                }
            });
        }

        if (poolsButton) {
            poolsButton.addEventListener('click', function() {
                location.href = '/pools';
            });
        }

        if (copyBtn) {
            copyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                copyApiKey();
            });
        }

        if (apiRefreshBtn) {
            apiRefreshBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm("Are you sure you want to regenerate your API key? Your old key will be invalidated and you will only see the new key once. Make sure to copy it!")) {
                    socket.emit('refreshApiKey');
                }
            });
        }

        if (pinEditBtn) {
            pinEditBtn.addEventListener('click', function(e) {
                e.preventDefault();
                editPin();
            });
        }

        if (updatePinBtn) {
            updatePinBtn.addEventListener('click', function(e) {
                e.preventDefault();
                updatePin();
            });
        }

        if (cancelPinBtn) {
            cancelPinBtn.addEventListener('click', function(e) {
                e.preventDefault();
                editPin();
            });
        }
    });

    socket.on('apiKeyUpdated', (data) => {
        apiKeyValue = data;
        const apiKeyEl = document.getElementById('apiKey');
        const copyBtn = document.getElementById('copyApiBtn');

        if (!apiKeyEl) return;

        // Show the new API key (one-time view)
        apiKeyEl.innerHTML = '<strong>API Key:</strong> <span style="font-family: monospace;">' + apiKeyValue + '</span>';
        apiKeyEl.style.color = '#ff6b6b';
        apiKeyEl.style.fontWeight = 'bold';

        // Show copy button
        if (copyBtn) copyBtn.style.display = 'inline-block';

        // Auto-copy to clipboard
        navigator.clipboard.writeText(apiKeyValue)
            .then(() => {
                showNotification('API Key regenerated and copied to clipboard! This is the only time you\'ll see this key.', 'success');
            })
            .catch(() => {
                showNotification('API Key regenerated, but could not be copied to clipboard. Please copy it manually. This is the only time you\'ll see this key.', 'warning');
            });
    });

    socket.on('pinUpdated', (data) => {
        if (data.success) {
            showNotification("PIN updated successfully!", 'success');

            // Update the PIN display and button
            const pinEl = document.getElementById('pin');
            if (pinEl) {
                pinEl.innerHTML = '<strong>PIN:</strong> ████';
            }

            // Update the dialog title and button for next time
            const pinDialogTitle = document.getElementById('pinDialogTitle');
            if (pinDialogTitle) {
                pinDialogTitle.textContent = 'Change PIN';
            }

            // If current PIN field doesn't exist, we need to add it for next time
            const currentPinField = document.getElementById('currentPinField');
            if (!currentPinField) {
                const editPinForm = document.getElementById('editPinForm');
                const newPinField = editPinForm.querySelector('div:first-child');
                const currentPinHTML = `
                    <div class="editPinInputs" id="currentPinField">
                        <label for="currentPin">Current PIN:</label>
                        <input type="password" id="currentPin" name="currentPin" class="revampButton revampWithText" pattern="\\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                    </div>
                `;
                newPinField.insertAdjacentHTML('beforebegin', currentPinHTML);
            }
        }
    });

    // Handle socket error events and display them in the error dialog
    socket.on('error', (errorMsg) => {
        showNotification(errorMsg);
    });
</script>
