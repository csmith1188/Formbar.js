<%- include('../partials/header_content') %>
    <%- include('../partials/sockets') %>
    <%- include('../partials/formbar_header') %>
    <style>
        #apiKey {
            white-space: pre;
        }
    </style>
        <body style="display: flex;" role="document" tabindex="0">
            <div id="editPin" style="display: none;">
                <div class="revampDiv">
                    <h1>Edit PIN</h1>
                    <div id="editPinForm">
                        <div class="editPinInputs">
                            <label for="currentPin">Current PIN:</label>
                            <input type="password" id="currentPin" name="currentPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                        </div>
                        <div class="editPinInputs">
                            <label for="newPin">New PIN:</label>
                            <input type="password" id="newPin" name="newPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                        </div>
                        
                        <div class="editPinInputs">
                            <label for="confirmNewPin">Confirm New PIN:</label>
                            <input type="password" id="confirmNewPin" name="confirmNewPin" class="revampButton revampWithText" pattern="\d{6}" maxlength="6" minlength="4" required autocomplete="off">
                        </div>

                        <div class="editPinInputs" style="margin-top: 20px;">
                            <button type="submit" class="revampButton warningButton" onclick="updatePin()">Update PIN</button>
                            <button type="button" class="revampButton" onclick="editPin()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id='profileInformation' class="revampDiv">
                <h1>Profile Information</h1>
                <p id='displayName''><strong>Display Name:</strong> <%- displayName %></p>

                <% if (email !== "Hidden") { %> <!-- If the user doesn't have permissions to see the email, don't show it -->
                    <p id="email"><strong>Email:</strong> <%- email %></p>
                <% } %>

                <p id='digipogs'><strong>Digipogs:</strong> <%- Math.floor(digipogs) %></p>
                <p id='userId'><strong>ID:</strong> <%- id %></p>
                <div class="sensitiveInfo">
                    <p id='apiKey'><strong>API Key:</strong> ████████</p>
                    <div id='apiKeyButton'>
                        <button onclick="copyApiKey()" class="squareButton hideMobile" style="display: none;" id="copyApiBtn">
                            <img src="/img/icons/clipboard-outline.svg" alt="Copy API Key">
                        </button>
                        <button id='apiRefresh' onclick='refreshApiKey()' class="squareButton warningButton" title="Regenerate API Key">
                            <img src="/img/icons/refresh-outline.svg" alt="Regenerate API Key">
                        </button>
                    </div>
                </div>
                <div class="sensitiveInfo">
                    <p id='pin'><strong>PIN:</strong> <%= pin ? '████' : 'Not Set' %></p>
                    <div id='apiKeyButton'>
                        <button id='pinEdit' onclick='editPin()' class="squareButton warningButton" title="<%= pin ? 'Change' : 'Set' %> PIN">
                            <img src="/img/icons/pencil-outline.svg" alt="<%= pin ? 'Change' : 'Set' %> PIN">
                        </button>
                    </div>
                </div>

                <div class="pogMeter">
                    <p>Pog Meter</p>
                    <div id="pogMeter" class="revampDivAlt">
                        <div id="pogMeterFill">
    
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="revampButton" id="transactionsBtn" style="margin-right: auto;">Transactions</button>
                    <button class="revampButton" id="transactionsBtn" onclick="location.href = '/pools'">Pog Pools</button>
                </div>
            </div>
        </body>
        <script>
            let apiKeyValue = null; // API key is hashed and cannot be displayed
            let pinValue = null; // PIN is hashed and cannot be displayed
            let pogMeterValue = <%- pogMeter / 5 %>;

            document.getElementById('pogMeterFill').style.setProperty('--pogPercent', pogMeterValue + '%');

            let apiKey = document.getElementById('apiKey');
            let pin = document.getElementById('pin');
                
            function copyApiKey() {
                if (apiKeyValue) {
                    navigator.clipboard.writeText(apiKeyValue);
                    alert("API Key copied to clipboard!");
                }
            }

            // Handle transactions button, depending on if it's the user's own profile or not
            const userIdElement = document.getElementById('userId');
            const userIdText = userIdElement ? userIdElement.textContent.replace(/[^0-9]/g, '') : '';
            const transactionsButton = document.getElementById('transactionsBtn');
            transactionsButton.onclick = () => {
                if (<%- isOwnProfile ? 'true' : 'false' %>) {
                    location.href = '/profile/transactions';
                } else {
                    location.href = `/profile/transactions/${userIdText}`;
                }
            };

            function updatePin() {
                const currentPin = document.getElementById('currentPin').value;
                const newPin = document.getElementById('newPin').value;
                const confirmNewPin = document.getElementById('confirmNewPin').value;

                if (newPin !== confirmNewPin) {
                    alert("New PIN and Confirm New PIN do not match.");
                    return;
                }

                if(!isFinite(newPin)) {
                    alert("PIN must only contain numbers.");
                    return;
                }

                if(newPin.length < 4 || newPin.length > 6) {
                    alert("PIN must be between 4 and 6 digits.");
                    return;
                }

                // Note: We can no longer verify the current PIN on client side since it's hashed
                // The server will need to verify if needed, but for now we allow PIN changes without verification

                socket.emit('refreshPin', newPin);

                // Clear input fields
                document.getElementById('currentPin').value = '';
                document.getElementById('newPin').value = '';
                document.getElementById('confirmNewPin').value = '';

                // Close the edit PIN modal
                editPin();
            }

            function refreshApiKey() {
                if(confirm("Are you sure you want to regenerate your API key? Your old key will be invalidated and you will only see the new key once. Make sure to copy it!")) {
                    socket.emit('refreshApiKey');
                }
            }

            function editPin() {
                document.getElementById('backgroundDarken').classList.toggle('open');
                document.getElementById('editPin').style.display = 
                (document.getElementById('editPin').style.display === 'flex') ? 'none' : 'flex';
            }
            
            socket.on('apiKeyUpdated', (data) => {
                apiKeyValue = data;
                const apiKeyEl = document.getElementById('apiKey');
                const copyBtn = document.getElementById('copyApiBtn');

                if (!apiKeyEl) return;

                // Show the new API key (one-time view)
                apiKeyEl.innerHTML = '<strong>API Key:</strong> <span style="font-family: monospace;">' + apiKeyValue + '</span>';
                apiKeyEl.style.color = '#ff6b6b';
                apiKeyEl.style.fontWeight = 'bold';

                // Show copy button
                if (copyBtn) copyBtn.style.display = 'inline-block';

                // Auto-copy to clipboard
                navigator.clipboard.writeText(apiKeyValue);
                alert("✅ New API Key generated and copied to clipboard!\n\n⚠️ IMPORTANT: This is the only time you'll see this key. Save it securely!\n\nKey: " + apiKeyValue);
            });

            socket.on('pinUpdated', (data) => {
                pinValue = data;
                const pinEl = document.getElementById('pin');
                if (!pinEl) return;

                // Show the new PIN (one-time view)
                pinEl.innerHTML = '<strong>PIN:</strong> <span style="font-family: monospace;">' + pinValue + '</span>';
                pinEl.style.color = '#ff6b6b';
                pinEl.style.fontWeight = 'bold';

                alert("✅ PIN updated successfully!\n\n⚠️ IMPORTANT: This is the only time you'll see this PIN. Remember it!\n\nNew PIN: " + pinValue);

                // After 30 seconds, hide the PIN again
                setTimeout(() => {
                    pinEl.innerHTML = '<strong>PIN:</strong> ████';
                    pinEl.style.color = '';
                    pinEl.style.fontWeight = '';
                    pinValue = null;
                }, 30000);
            });
        </script>