<!DOCTYPE html>
<%- include('../partials/header_content') %>
<%- include('../partials/sockets') %>

        <html lang="en">

        <head>
            <style>
                body {
                    padding-top: 52px !important;
                }

                table {
                    outline: none !important;
                    border-spacing: 0;
                    width: 100%;
                    table-layout: fixed;
                }

                td, th {
                    padding: 20px 0;
                    border-bottom: 2px solid var(--lightMode-menu-border);
                    word-wrap: break-word;
                    overflow: hidden;
                }

                tr {
                    position: relative;
                }

                div.transactionHistory {
                    margin: auto;
                    width: 80%;
                    height: 100vh;
                    display: flex;
                    justify-content: start;
                    align-items: center;
                    overflow: auto;
                    flex-direction: column;
                    padding: 5px 0 60px 0;
                }
                
                .buttons {
                    display: flex;
                    flex-direction: row;
                    gap: 10px;
                    margin-top: 10px;
                }

                .description {
                    max-width: 200px;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                /* Column width controls */
                th:nth-child(1), td:nth-child(1) { width: 5%; } /* Name */
                th:nth-child(2), td:nth-child(2) { width: 15%; } /* Name */
                th:nth-child(3), td:nth-child(3) { width: 10%; } /* Owner */
                th:nth-child(4), td:nth-child(4) { width: 15%; } /* Members */
                th:nth-child(5), td:nth-child(5) { width: 30%; } /* Description */
                th:nth-child(6), td:nth-child(6) { width: 10%; } /* Amount */
                th:nth-child(7), td:nth-child(7) { width: 20%; } /* Options */

                div.membersOptions {
                    position: absolute;
                    top: 0;
                    left: 0;
                    background: #000a;
                    width: 100dvw;
                    height: 100dvh;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 4;
                    gap: 20px;
                    backdrop-filter: blur(10px);
                    pointer-events: none;
                    opacity: 0;
                    transition: 0.2s opacity ease-in-out;
                }

                div.membersOptions.open {
                    pointer-events: all;
                    opacity: 1;
                }
            </style>
        </head>

        <body role="document" tabindex="0">
            <%- include('../partials/formbar_header') %>

            
            <div class="transactionHistory">
                <h1>Your pog pools!</h1>

                <table class="revampDiv">
                    <tr>
                        <th>ID</th>
                        <th class="hideMobile">Name</th>
                        <th class="hideMobile">Owner</th>
                        <th class="hideMobile">Members</th>
                        <th class="hideMobile">Description</th>
                        <th>Amount</th>
                        <th>Options</th>
                    </tr>

                    <% 
                        // parse incoming JSON strings once and use ownedPools for ownership checks
                        const poolsArr = (typeof pools === "string" && pools.length) ? JSON.parse(pools) : (Array.isArray(pools) ? pools : []);
                        const owned = (typeof ownedPools === "string" && ownedPools.length) ? JSON.parse(ownedPools) : (Array.isArray(ownedPools) ? ownedPools : []);
                        if(poolsArr.length > 0) { 
                            poolsArr.forEach(function(pool) { 
                                // normalize id access: pool.pool_id || pool.id
                                const pid = pool.pool_id !== undefined ? pool.pool_id : pool.id;
                                const isOwned = owned.includes(String(pid));
                    %>
                        <tr id="pool-<%= pid %>">
                            <td><%= pid %></td>
                            <td class="description hideMobile"><%= pool.name %></td>
                            <td class="hideMobile">
                                <% 
                                    // Show "You" if this pool is in the user's owned pools; otherwise try pool.owners or legacy pool.owner
                                    if (isOwned) { %>
                                        You
                                <% } else { 
                                        if (Array.isArray(pool.owners) && pool.owners.length > 0) { %>
                                            <%= pool.owners.join(', ') %>
                                <%      } else if (pool.owner !== undefined) { %>
                                            <%= pool.owner %>
                                <%      } else { %>
                                            None
                                <%      } 
                                    } %>
                            </td>
                            <td class="hideMobile"><%= Array.isArray(pool.members) && pool.members.length > 0 ? pool.members.join(', ') : "None" %></td>
                            <td class="hideMobile description" title="<%= pool.description %>"><%= pool.description %></td>
                            <td><%= pool.amount %></td>
                            <td>
                                <div style="display: flex; gap: 5px; justify-content: center;" class="transactionButtons">
                                    <% if(isOwned) { %>
                                        <button class="revampButton acceptButton squareButton" style="padding: 5px;" onclick="poolPayout(<%= pid %>)">
                                            <img src="/img/icons/cash-outline.svg" title="Payout" alt="Payout" style="filter: invert(0) !important">
                                        </button>
                                        <button class="revampButton acceptButton squareButton" style="padding: 5px;" onclick="membersOptions.classList.add('open');membersOptions.dataset.poolId = <%= pid %>;">
                                            <img src="/img/icons/person.svg" title="Add or Remove Members" alt="Add or Remove Members" style="filter: invert(0) !important">
                                        </button>
                                        <% if(pid !== 0) { %>
                                            <button class="revampButton warningButton squareButton" style="padding: 5px;" onclick="if(confirm('Are you sure you would like to delete <%=pool.name%>?')) socket.emit('poolDelete', { poolId: <%= pid %> })">
                                                <img src="/img/icons/trash-outline.svg" title="Delete Pool" alt="Delete Pool" style="filter: invert(0) !important">
                                            </button>
                                        <% } else { %>
                                            <button class="revampButton warningButton squareButton" style="padding: 5px;" disabled>
                                                <img src="/img/icons/trash-outline.svg" title="Delete Pool" alt="Delete Pool" style="filter: invert(0) !important">
                                            </button>
                                        <% } %>
                                    <% } else { %>
                                        <div>
                                            You do not own this pool.
                                        </div>
                                    <% } %>
                                </div>
                            </td>
                        </tr>
                    <%     }); 
                        } else { %>
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>You currently have no pools.</td>
                            <td></td>
                            <td></td>
                        </tr>
                    <% } %>
                </table>
            </div>

            <button class="revampButton" style="position: fixed; bottom: 20px; left: 20px; padding: 15px 25px; font-size: 18px;" onclick="location.href = '/profile/transactions'">
                Transactions
            </button>

            <button class="revampButton acceptButton" style="position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; font-size: 18px;" onclick="createPool()">
                Create Pool
            </button>

            <div class="membersOptions" data-pool-id="-1">
                <button class="backButton revampButton" style="margin-top: 70px;margin-left: 10px;" onclick="membersOptions.classList.remove('open');membersOptions.dataset.poolId = -1;">
                    <img src="/img/icons/close-outline.svg" alt="Close Member Options" style="filter: invert(1) !important;">
                </button>

                <div class="addMember">
                    <h2>Add Member</h2>
                    <input type="number" id="addMemberUserId" class="revampButton revampWithText" placeholder="User ID" style="width: 100%; padding: 10px; margin-bottom: 10px;" autocomplete="off">
                    <button class="revampButton acceptButton" style="width: 100%;" onclick="memberOption(true)">Add Member</button>
                </div>
                <div class="removeMember">
                    <h2>Remove Member</h2>
                    <input type="number" id="removeMemberUserId" class="revampButton revampWithText" placeholder="User ID" style="width: 100%; padding: 10px; margin-bottom: 10px;" autocomplete="off">
                    <button class="revampButton warningButton" style="width: 100%;" onclick="memberOption(false)">Remove Member</button>
                </div>
            </div>
        </body>
                
        <script>
            
            socket.on('poolCreateResponse', (data) => {
                location.reload();
            })

            socket.on('poolDeleteResponse', (data) => {
                location.reload();
            })

            socket.on('poolAddMemberResponse', (data) => {
                location.reload();
            })

            socket.on('poolRemoveMemberResponse', (data) => {
                location.reload();
            })

            socket.on('poolPayoutResponse', (data) => {
                location.reload();
            })

            function createPool() {
                let name = prompt("Enter a name for the pool:");
                if(!name) return alert("You must enter a name to create a pool.");

                let description = prompt("Enter a description for the pool:");
                if(!description) return alert("You must enter a description to create a pool.");

                socket.emit('poolCreate', { name: name, description: description });
            }

            const membersOptions = document.querySelector('.membersOptions');

            function memberOption(add=true) {
                const poolId = parseInt(membersOptions.dataset.poolId);
                if(poolId < 0) return;

                let userIdInputId = add ? "addMemberUserId" : "removeMemberUserId";

                let userId = document.getElementById(userIdInputId).value;
                if(!userId) return alert("You must enter a user ID to add a member.");

                if(!parseInt(userId) || parseInt(userId) <= 0) return alert("You must enter a valid user ID to add a member.");

                if(add) {
                    socket.emit('poolAddMember', { poolId: poolId, userId: parseInt(userId) });
                } else {
                    socket.emit('poolRemoveMember', { poolId: poolId, userId: parseInt(userId) });
                }
            }

            function poolPayout(poolId2) {
                const poolId = parseInt(poolId2)

                let confirmation = confirm("Are you sure you want to payout this pool? This will distribute the pool's amount evenly among all members.");

                if(confirmation) socket.emit('poolPayout', { poolId: poolId });
            }
        </script>
</html>