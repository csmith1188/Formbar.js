<%- include('../partials/header_content') %>
    <%- include('../partials/sockets') %>

        <body id="colorContent" role="document" tabindex="0" class="newClassPage">
            <%- include('../partials/formbar_header') %>

                <!-- <header id="quickMenu" style="margin: 0 auto;position: absolute;left: 50%;transform: translate(-50%);">
                    <button id="classesMenu" class="quickButton tab pressed revampButton"
                        data-tab-group="classTabs">Classes</button>
                    <button id="createClassMenu" class="quickButton tab revampButton" data-tab-group="classTabs">Create
                        a class</button>
                </header> -->

                <div id="content" class="contentBox" style="margin: auto;">
                    <div id="classesMenu" class="tabContent default" data-tab-group='classTabs'>
                        <% if (currentUser.permissions>= TEACHER_PERMISSIONS) { %>
                            <form action="createClass" method="post" id="selectClassForm">
                                <label for="manageClassSelect" class="headerText">Manage a class</label>
                                <select id="manageClassSelect" name="id" class="revampButton">

                                </select>
                                <div class="buttonsHolder">
                                    <input type="text" name="submittionType" value="select" hidden>
                                    <input type="submit" id="submitButton" class="quickButton revampButton pressed"
                                        value="Go" onsubmit="return false;">
                                    <button class="quickButton revampButton warningButton" type="button"
                                        onclick="deleteClass()">Delete</button>
                                </div>


                            </form>

                            <!-- <div id="createClassMenu" class="tabContent" data-tab-group='classTabs'> -->
                            <form action="createClass" method="post" id="createClass">
                                <label for="emailBox" class="headerText h2" style="margin-top: 40px">Create a class</label>

                                <div class="buttonsHolder createClassButtons" id="createClassButtons">
                                    <input type="text" id="classNameBox" name="name" placeholder="Class Name" value=""
                                        autocomplete="off" class="revampButton revampWithText" required>
                                    <input type="text" name="submittionType" value="create" hidden>
                                    <input type="submit" id="submitButton" class="quickButton revampButton pressed"
                                        value="Create" onsubmit="return false;">
                                </div>
                            </form>
                            <!-- </div> -->
                            <% } %>

                    </div>



                    <label for="joinedKey" class="headerText">Join a class</label>
                    <% if (joinedClasses.length> 0) { %>
                        <form action="selectClass" method="post" class="joinClassForm">
                            <select id="joinedKey" name="id" required class="revampButton">
                                <option value="" disabled selected>Joined classes</option>
                                <% for(let joinedClass of joinedClasses) { %>
                                    <option value="<%- joinedClass.id %>">
                                        <%- joinedClass.name %>
                                    </option>
                                    <% } %>
                            </select>
                            <input type="submit" id="submitJoinedButton"
                                class="button unselectable revampButton quickButton" value="Submit"
                                onsubmit="return false;">
                        </form>
                        <% } %>

                            <form action="selectClass" method="post" class="joinClassForm" style="margin-top: 20px;">
                                <input type="text" required name="key" id="joinKey" placeholder="Class code"
                                    class="revampButton revampWithText">
                                <input type="submit" id="submitJoinButton"
                                    class="button unselectable revampButton quickButton" value="Submit"
                                    onsubmit="return false;">
                            </form>
                </div>
        </body>
        <script>
            let startClassForm = document.getElementById("selectClassForm")
            let manageClassSelect = document.getElementById("manageClassSelect")

            function deleteClass() {
                let classId = manageClassSelect.value
                let className = manageClassSelect.options[manageClassSelect.selectedIndex].text

                let confirmation = confirm(`are you sure you want to delete the class ${className}`)
                if (!confirmation) return

                manageClassSelect.options[manageClassSelect.selectedIndex].remove();
                socket.emit('deleteClass', classId)
            }
            if (currentUser && currentUser.permissions >= TEACHER_PERMISSIONS) {
                socket.emit('getOwnedClasses', currentUser.email)
                socket.on('getOwnedClasses', (ownedClasses) => {
                    if (ownedClasses.length > 0) {
                        startClassForm.style.opacity = "1"
                        startClassForm.style.pointerEvents = "all";
                    } else {
                        startClassForm.style.opacity = "0.5";
                        startClassForm.style.pointerEvents = "none";
                        startClassForm.style.opacity = "0.5";
                        startClassForm.style.pointerEvents = "none";
                        return
                    }

                    for (let classroom of ownedClasses) {
                        let option = document.createElement('option')
                        option.value = classroom.id
                        option.innerText = classroom.name
                        manageClassSelect.appendChild(option.cloneNode(true))
                    }
                })
            }
        </script>
        <script src='/js/tabs.js'></script>

        <script>
            if (document.getElementById("joinedKey")) {
                document.getElementById("joinedKey").addEventListener('input', () => {
                    if (event.target.value) {
                        document.getElementById("submitJoinedButton").classList.remove("unselectable")
                    } else {
                        document.getElementById("submitJoinedButton").classList.add("unselectable")
                    }
                })
            }

            document.getElementById("joinKey").addEventListener('input', (event) => {
                if (event.target.value) {
                    document.getElementById("submitJoinButton").classList.remove("unselectable")
                } else {
                    document.getElementById("submitJoinButton").classList.add("unselectable")
                }
            })

            socket.on('joinClass', (success) => {
                if (success === true) {
                    window.location.href = '/student';
                }
            });
        </script>